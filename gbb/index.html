<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="application-name" content="NPC Screen Repair Configurator">
<meta property="og:title" content="North Point Computers - Screen Repairs">
<meta name="twitter:title" content="North Point Computers - Screen Repairs">
<style>
  :root {
    color-scheme: light;
    --bg: #f6f7fb;
    --card: #ffffff;
    --border: #d8ddea;
    --border-strong: #cfd3dc;
    --accent: #1e66ff;
    --accent-soft: rgba(30,102,255,.1);
    --text: #11151c;
    --muted: #5b6472;
    --divider: #eef1f7;
    --note-bg: #fff8e6;
    --note-border: #ffe5a3;
    --error: #b00020;
    --success: #0f9d58;
  }
  * { box-sizing: border-box; }
  html,body { margin:0; padding:0; font-family: "SF Pro Text",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); }
  h1 { font-size:24px; margin:0 0 10px; }
  h2 { font-size:18px; margin:0; }
  h3 { font-size:18px; margin:0; }
  p { margin:0; }
  .wrap { max-width:1080px; margin:0 auto; padding:16px; }
  .intro { margin-bottom:16px; color:var(--muted); font-size:14px; }
  .grid { display:grid; gap:14px; grid-template-columns:1fr; }
  @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr .8fr; align-items:start; } }
  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 2px 8px rgba(17,17,17,.04); overflow:hidden; }
  .card h2 { padding:18px 20px 0; }
  .card .section { padding:16px 20px; border-top:1px solid var(--divider); }
  label.head { display:block; font-weight:600; margin-bottom:8px; font-size:15px; }
  select { width:100%; appearance:none; -webkit-appearance:none; border:1px solid var(--border); border-radius:11px; padding:12px 14px; font-size:15px; background:var(--card); color:var(--text); box-shadow:0 1px 0 rgba(17,17,17,.03); }
  #modelSelect { font-size:22.5px; font-weight:600; }
  select:focus { outline:3px solid rgba(30,102,255,.25); border-color:var(--accent); }
  .hint { font-size:12px; color:var(--muted); margin-top:6px; line-height:1.4; }
  .tabs { display:flex; gap:10px; padding:0 20px 18px; flex-wrap:wrap; }
  .tab { flex:1 1 160px; text-align:center; padding:14px 12px; border:1px solid var(--border-strong); border-radius:12px; font-weight:600; cursor:pointer; transition: all .15s ease; background:var(--card); box-shadow:0 1px 2px rgba(17,17,17,.04); }
  .tab small { display:block; font-size:12px; color:var(--muted); margin-top:6px; font-weight:500; }
  .tab.active { border-color:var(--accent); box-shadow:0 0 0 2px var(--accent-soft) inset,0 6px 20px rgba(30,102,255,.12); }
  .tab:not(.active):hover { border-color:var(--accent); }
  .tier-indicator { margin:-8px 20px 16px; padding:12px 16px; background:#eaf3ff; border:1px solid #cfe2ff; border-radius:12px; display:flex; justify-content:space-between; gap:16px; align-items:center; font-size:14px; }
  .tier-indicator strong { font-size:15px; }
  .radio-list,.check-list { display:grid; gap:10px; }
  .radio-item,.check-item { border:1px solid var(--border); border-radius:12px; padding:14px; display:flex; gap:14px; align-items:flex-start; cursor:pointer; transition:border .15s ease, box-shadow .15s ease; }
  .radio-item input,.check-item input { margin-top:3px; }
  .radio-item.active,.check-item input:checked + label .row { border-color:var(--accent); }
  .radio-item.active { box-shadow:0 0 0 2px var(--accent-soft); border-color:var(--accent); }
  .radio-item label,.check-item label { flex:1; cursor:pointer; }
  .row { display:flex; justify-content:space-between; gap:10px; align-items:center; font-size:14px; }
  .row strong { font-size:15px; }
  .price-chip { font-weight:700; }
  .summary { position:sticky; top:16px; }
  .summary .section { display:flex; flex-direction:column; gap:12px; }
  .summary .line { display:flex; justify-content:space-between; font-size:14px; gap:12px; }
  .summary .line span:first-child { color:var(--muted); }
  #summaryModel { font-size:21px; font-weight:700; }
  .summary .total { font-size:22px; font-weight:800; margin-top:4px; }
  .summary .note { background:var(--note-bg); border:1px solid var(--note-border); color:#5c4700; padding:10px 12px; border-radius:10px; font-size:12px; line-height:1.5; }
  .divider { height:1px; background:var(--divider); }
  .cta-wrap { display:flex; flex-direction:column; gap:8px; }
  .btn-primary { display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:14px 18px; border-radius:12px; border:0; background:var(--accent); color:#fff; font-size:16px; font-weight:700; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; }
  .btn-primary:hover { transform:translateY(-1px); box-shadow:0 8px 22px rgba(30,102,255,.22); }
  .btn-primary[disabled] { opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }
  .btn-paypal { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:13px 18px; border-radius:12px; border:1px solid #003087; background:linear-gradient(135deg,#ffc439,#f7b600); color:#003087; font-size:15px; font-weight:700; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; text-decoration:none; }
  .btn-paypal:hover { transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,48,135,.18); }
  .btn-paypal[disabled] { opacity:.7; cursor:not-allowed; transform:none; box-shadow:none; }
  .btn-secondary { background:transparent; border:0; color:var(--muted); font-size:13px; text-decoration:underline; cursor:pointer; }
  .status { font-size:13px; line-height:1.4; border-radius:10px; padding:10px 12px; }
  .status.error { background:#ffe5e9; color:var(--error); border:1px solid rgba(176,0,32,.3); }
  .status.success { background:#e8f5ed; color:var(--success); border:1px solid rgba(15,157,88,.35); }
  .status.hidden { display:none; }
  .addon-grid { display:grid; gap:10px; }
  @media (min-width:620px) { .addon-grid { grid-template-columns:repeat(2,minmax(0,1fr)); } }
  .legal { font-size:11px; color:var(--muted); margin-top:16px; line-height:1.5; }
  .floating-total { position:fixed; right:24px; bottom:24px; background:var(--card); color:var(--text); padding:18px; border-radius:18px; box-shadow:0 18px 40px rgba(17,17,17,.15); border:1px solid var(--border); display:flex; flex-direction:column; gap:10px; z-index:1000; width:280px; max-width:calc(100vw - 48px); }
  .floating-total .floating-checkout { width:100%; display:flex; flex-direction:column; align-items:flex-start; justify-content:flex-start; gap:6px; text-align:left; }
  .floating-total .floating-checkout span.label { font-size:13px; letter-spacing:.02em; text-transform:none; opacity:.95; }
  .floating-total .floating-checkout span.amount { font-size:20px; font-weight:800; margin-left:auto; }
  .floating-total .floating-pay { width:100%; }
  @media (min-width:901px){
    .floating-total { display:none; }
  }
  @media (max-width:900px){
    body { padding-bottom:200px; }
    .floating-total { left:16px; right:16px; bottom:16px; width:auto; }
  }
</style>
</head>
<body>
<div class="wrap">
  <p class="intro" id="introCopy">Choose the repair tier that fits you best, add any extras, then continue to secure checkout on Lowbies.com. Payments are processed by WooCommerce with PayPal or card.</p>

  <div class="grid">
    <div class="card">
      <h2>Configure your repair</h2>
      <div class="tabs" role="tablist">
        <div class="tab active" id="tab-better" role="tab" tabindex="0" aria-selected="true" aria-controls="panel-tier" data-tier="better">Standard<small>33-Day Warranty</small></div>
        <div class="tab" id="tab-good" role="tab" tabindex="0" aria-selected="false" aria-controls="panel-tier" data-tier="good">Discount<small>No Warranty</small></div>
        <div class="tab" id="tab-premium" role="tab" tabindex="0" aria-selected="false" aria-controls="panel-tier" data-tier="premium">Premium<small>183-Day Warranty</small></div>
      </div>
      <div class="tier-indicator" id="tierIndicator">
        <div>
          <strong id="tierIndicatorTitle">Standard — 33-Day Warranty</strong>
          <div id="tierIndicatorCopy">Baseline option with balanced coverage and price.</div>
        </div>
        <div id="tierIndicatorMath">Discount −$19 · Premium +$20</div>
      </div>

      <div class="section" id="panel-tier">
        <label for="modelSelect" class="head">iPhone model</label>
        <select id="modelSelect"></select>
        <div class="hint">Pricing covers all colors and storage options. Mini/Plus/Pro variants are listed where available.</div>
      </div>

      <div class="section">
        <label class="head">Screen quality</label>
        <div class="radio-list" id="qualityOptions"></div>
        <div class="hint">Premium Aftermarket is our best value. OLED is the closest match to factory panels and only available on select devices.</div>
      </div>

      <div class="section">
        <label class="head">Priority service</label>
        <div class="radio-list" id="priorityOptions"></div>
      </div>

      <div class="section">
        <label class="head">Add-ons</label>
        <div class="addon-grid" id="addonOptions"></div>
        <div class="hint">Add-ons are performed during the same appointment as your screen repair.</div>
      </div>

      <div class="section">
        <div class="note" id="warrantyNote"></div>
      </div>
    </div>

    <aside class="card summary" aria-live="polite">
      <h3 style="padding:18px 20px 0;">Live summary</h3>
      <div class="section">
        <div class="line"><span>Model</span><span id="summaryModel">—</span></div>
        <div class="line"><span>Tier &amp; warranty</span><span id="summaryTier">—</span></div>
        <div class="line"><span>Screen quality</span><span id="summaryQuality">—</span></div>
        <div class="line"><span>Priority</span><span id="summaryPriority">—</span></div>
        <div class="line"><span>Add-ons</span><span id="summaryAddons">None</span></div>
        <div class="divider"></div>
        <div class="line"><span>Base</span><span id="priceBase">$0.00</span></div>
        <div class="line"><span>Screen quality</span><span id="priceQuality">$0.00</span></div>
        <div class="line"><span>Priority</span><span id="pricePriority">$0.00</span></div>
        <div class="line"><span>Add-ons</span><span id="priceAddons">$0.00</span></div>
        <div class="divider"></div>
        <div class="total" id="priceTotal">$0.00</div>
        <div class="note" id="summaryWarranty"></div>
        <div class="cta-wrap">
          <button class="btn-primary" id="checkoutBtn" type="button">Continue to Pay on Lowbies.com</button>
          <button class="btn-paypal" id="paypalBtn" type="button">
            <span id="paypalBtnLabel">Pay with credit card or PayPal</span>
          </button>
          <button class="btn-secondary" id="resetBtn" type="button">Reset choices</button>
          <div class="status hidden" id="checkoutStatus" role="status"></div>
        </div>
      </div>
      <p class="legal" id="legalCopy">Checkout opens in a new tab on Lowbies.com with product ID 1179 pre-loaded. Taxes are calculated during WooCommerce checkout.</p>
    </aside>
  </div>
  <div class="floating-total" id="floatingTotal" aria-live="polite">
    <button class="btn-primary floating-checkout" id="floatingCheckoutBtn" type="button">
      <span class="label" id="floatingCheckoutLabel">Continue to Pay on Lowbies.com</span>
      <span class="amount" id="floatingTotalAmount">$0.00</span>
    </button>
    <button class="floating-pay" id="floatingPayBtn" type="button">Pay with credit card or PayPal</button>
  </div>
</div>

<script>
(function(){
  var PRODUCT_ID = 1179;
  var SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ23t1Je_47yCfr-jVgCvXF00ljrmouanB9J8otul2UNDBZeMkTsqibZo3Nzgl_bnJ-w8XE53aZNNUv/pub?output=csv';
  var locationOrigin = '';
  if(typeof window !== 'undefined' && window.location){
    if(window.location.origin){
      locationOrigin = window.location.origin;
    } else {
      locationOrigin = window.location.protocol + '//' + window.location.host;
    }
  }
  var locationProtocol = (typeof window !== 'undefined' && window.location && window.location.protocol) ? window.location.protocol : 'https:';
  var locationHost = (typeof window !== 'undefined' && window.location && window.location.hostname) ? window.location.hostname : '';
  var qualityCopy = {
    aftermarket: {
      title: 'Premium Aftermarket',
      description: 'Excellent color, brightness, and responsiveness for most customers.',
      priceLabel: 'Included'
    },
    oled: {
      title: 'OEM-Match OLED',
      description: 'Factory-spec vividness and deep blacks. Availability depends on model.',
      priceLabel: '(+ $0)'
    }
  };
  var models = [
    { id: '11', label: 'iPhone 11' },
    { id: '12', label: 'iPhone 12' },
    { id: '12 Pro', label: 'iPhone 12 Pro' },
    { id: '12 Pro Max', label: 'iPhone 12 Pro Max' },
    { id: '13 Mini', label: 'iPhone 13 Mini' },
    { id: '13', label: 'iPhone 13' },
    { id: '13 Pro', label: 'iPhone 13 Pro' },
    { id: '13 Pro Max', label: 'iPhone 13 Pro Max' },
    { id: '14', label: 'iPhone 14' },
    { id: '14 Plus', label: 'iPhone 14 Plus' },
    { id: '14 Pro', label: 'iPhone 14 Pro' },
    { id: '14 Pro Max', label: 'iPhone 14 Pro Max' },
    { id: '15', label: 'iPhone 15' },
    { id: '15 Plus', label: 'iPhone 15 Plus' },
    { id: '15 Pro', label: 'iPhone 15 Pro' },
    { id: '15 Pro Max', label: 'iPhone 15 Pro Max' },
    { id: '16', label: 'iPhone 16' },
    { id: '16 Plus', label: 'iPhone 16 Plus' },
    { id: '16 Pro', label: 'iPhone 16 Pro' },
    { id: '16 Pro Max', label: 'iPhone 16 Pro Max' },
    {
      id: 'legacy-6-xr',
      label: 'iPhone 6 – XR (all models)',
      payload: '6',
      family: ['6','6 Plus','6s','6s Plus','7','7 Plus','8','8 Plus','X','XR']
    }
  ];
  var baseBetter = {
    '6':99,
    '11':139,'12':139,'12 Pro':169,'12 Pro Max':209,
    '13 Mini':149,'13':149,'13 Pro':169,'13 Pro Max':209,
    '14':149,'14 Plus':149,'14 Pro':169,'14 Pro Max':209,
    '15':149,'15 Plus':149,'15 Pro':169,'15 Pro Max':209,
    '16':149,'16 Plus':149,'16 Pro':169,'16 Pro Max':209
  };
  var oledSurcharge = {
    '6':null,
    '11':null,
    '12':99,'12 Pro':99,'12 Pro Max':129,
    '13 Mini':139,'13':109,'13 Pro':189,'13 Pro Max':219,
    '14':119,'14 Plus':179,'14 Pro':249,'14 Pro Max':349,
    '15':249,'15 Plus':209,'15 Pro':359,'15 Pro Max':439,
    '16':299,'16 Plus':409,'16 Pro':449,'16 Pro Max':529
  };
  var tierCopy = {
    good: {
      title: 'Discount — No Warranty',
      copy: 'Best for budget-conscious repairs. Includes functionality testing only.',
      note: 'No warranty coverage is included at the Discount tier.'
    },
    better: {
      title: 'Standard — 33-Day Warranty',
      copy: 'Balanced protection with a complimentary 33-day warranty.',
      note: 'Includes 33-day warranty against defects in parts and labor.'
    },
    premium: {
      title: 'Premium — 183-Day Warranty',
      copy: 'Maximum peace of mind with our longest warranty coverage.',
      note: 'Includes 183-day warranty with priority support for warranty claims.'
    }
  };
  var priorityOptions = [
    { id:'standard', label:'Standard Queue', price:0, description:'Completed in standard order after paid priority jobs. Typical turnaround 1–3 business days.' },
    { id:'priority', label:'Priority', price:39, description:'Moves ahead of standard jobs. Ideal for same-day or next-morning pickup.' },
    { id:'priority_plus', label:'Priority+', price:59, description:'Front-of-line service. Great for urgent, time-sensitive repairs.' },
    { id:'priority_pro', label:'Priority Pro', price:99, description:'Drop everything level. Reserved for business-critical or emergency requests.' }
  ];
  var addonOptions = [
    { id:'battery', label:'Battery Replacement', price:79, description:'Brand new battery installed alongside your screen repair.' },
    { id:'cleaning', label:'Charge Port Cleaning', price:50, description:'Deep clean to restore charging and data port performance.' },
    { id:'port', label:'Charge Port Replacement', price:89, description:'Full port swap including parts and labor.' },
    { id:'protector', label:'Screen Protector Install', price:10, description:'Tempered glass protector installed after repair.' }
  ];
  var tierDiff = { good: -19, better: 0, premium: 20 };
  var tierPricing = {};

  var state = {
    model: models[0] || null,
    tier: 'better',
    quality: 'aftermarket',
    priority: 'standard',
    addons: {}
  };

  var dom = {};
  var CTA_TEXT = 'Continue to Pay on Lowbies.com';
  var CTA_PAYPAL_TEXT = 'Pay with credit card or PayPal';
  var CTA_LOADING_TEXT = 'Preparing checkout…';
  var CTA_PAYPAL_LOADING_TEXT = 'Preparing PayPal…';
  var CTA_LOADING_ALT_TEXT = 'Preparing…';
  var DEFAULT_INTRO = 'Choose the repair tier that fits you best, add any extras, then continue to secure checkout on Lowbies.com. Payments are processed by WooCommerce with PayPal or card.';
  var DEFAULT_LEGAL = 'Checkout opens in a new tab on Lowbies.com with product ID 1179 pre-loaded. Taxes are calculated during WooCommerce checkout.';
  var copyContent = {
    intro: DEFAULT_INTRO,
    legal: DEFAULT_LEGAL
  };

  function $(id){ return document.getElementById(id); }

  function money(value){
    var amount = Math.round(Number(value || 0) * 100) / 100;
    return '$' + amount.toFixed(2);
  }

  function toCents(value){
    return Math.round(Number(value || 0) * 100);
  }

  function initializeTierPricing(){
    tierPricing = {};
    models.forEach(function(model){
      var key = model && (model.payload || model.id);
      if(!key) return;
      var base = Number(baseBetter[key] || 0);
      if(!isFinite(base)) base = 0;
      tierPricing[key] = {
        good: base + Number(tierDiff.good || 0),
        better: base + Number(tierDiff.better || 0),
        premium: base + Number(tierDiff.premium || 0)
      };
    });
  }

  function getTierPricingForKey(modelKey){
    if(!modelKey){
      return null;
    }
    if(!Object.prototype.hasOwnProperty.call(tierPricing, modelKey)){
      var base = Number(baseBetter[modelKey] || 0);
      if(!isFinite(base)) base = 0;
      tierPricing[modelKey] = {
        good: base + Number(tierDiff.good || 0),
        better: base + Number(tierDiff.better || 0),
        premium: base + Number(tierDiff.premium || 0)
      };
    }
    return tierPricing[modelKey];
  }

  initializeTierPricing();

  function formatMoneyNoTrailing(value){
    var formatted = money(Math.abs(value));
    if(formatted.endsWith('.00')){
      formatted = formatted.slice(0, -3);
    }
    return formatted;
  }

  function formatTierAdjustment(label, diff){
    if(!isFinite(diff)){
      return label + ' —';
    }
    if(Math.abs(diff) < 0.005){
      return label + ' Included';
    }
    var sign = diff > 0 ? '+' : '−';
    return label + ' ' + sign + formatMoneyNoTrailing(diff);
  }

  function updateTierIndicatorMath(){
    var indicator = $('tierIndicatorMath');
    if(!indicator){
      return;
    }
    var modelKey = getModelKey();
    var pricing = getTierPricingForKey(modelKey) || {};
    var betterPrice = Number(pricing.better);
    if(!isFinite(betterPrice)){
      betterPrice = Number(baseBetter[modelKey] || 0);
    }
    if(!isFinite(betterPrice)){
      betterPrice = 0;
    }
    var parts = [];
    if(Object.prototype.hasOwnProperty.call(pricing, 'good')){
      parts.push(formatTierAdjustment('Discount', Number(pricing.good) - betterPrice));
    } else {
      parts.push(formatTierAdjustment('Discount', Number(tierDiff.good || 0)));
    }
    if(Object.prototype.hasOwnProperty.call(pricing, 'premium')){
      parts.push(formatTierAdjustment('Premium', Number(pricing.premium) - betterPrice));
    } else {
      parts.push(formatTierAdjustment('Premium', Number(tierDiff.premium || 0)));
    }
    indicator.textContent = parts.join(' · ');
  }

  var SHEET_SECTION_FIELDS = ['section','type','category','group'];
  var SHEET_KEY_FIELDS = ['key','id','identifier','code','slug','model_key','model_id','modelid','option_key'];
  var SHEET_LABEL_FIELDS = ['label','name','title','display','model_label','model_name','option_label'];
  var SHEET_DESCRIPTION_FIELDS = ['description','details','note','notes','copy','summary','text'];
  var SHEET_BASE_FIELDS = ['better','standard','base','standard_price','better_price','base_price'];
  var SHEET_GOOD_FIELDS = ['good','discount','tier_good','good_price','discount_price'];
  var SHEET_GOOD_DIFF_FIELDS = ['good_diff','discount_diff','good_delta','discount_delta','good_adjustment'];
  var SHEET_PREMIUM_FIELDS = ['premium','best','tier_premium','premium_price'];
  var SHEET_PREMIUM_DIFF_FIELDS = ['premium_diff','premium_delta','best_diff','premium_adjustment'];
  var SHEET_OLED_FIELDS = ['oled','oled_surcharge','oled_price','amoled','oled_upgrade'];
  var SHEET_SORT_FIELDS = ['sort','order','position','rank','display_order'];
  var SHEET_PAYLOAD_FIELDS = ['payload','legacy','legacy_key','sku','model_payload','bridge_key'];
  var SHEET_FAMILY_FIELDS = ['family','aliases','variants','model_family'];
  var SHEET_ENABLED_FIELDS = ['enabled','active','show','visible','published','status'];
  var SHEET_PRICE_FIELDS = ['price','amount','cost','value','usd','fee'];
  var SHEET_TIER_FIELDS = ['tier','tier_key','level'];
  var SHEET_NOTE_FIELDS = ['note','notes','disclaimer','footnote'];
  var SHEET_TITLE_FIELDS = ['title','headline','label','name'];
  var SHEET_QUALITY_FIELDS = ['quality','quality_key','panel'];
  var SHEET_CTA_FIELDS = ['cta','button','action','key'];
  var SHEET_MODEL_HINT_FIELDS = ['model','model_label','model_name','standard','better','base'];
  var SHEET_PRIORITY_HINT_FIELDS = ['priority','queue','priority_label','priority_name'];
  var SHEET_ADDON_HINT_FIELDS = ['addon','add_on','upsell','extra','service'];
  var SHEET_TIER_HINT_FIELDS = ['tier','tier_name','warranty','note','premium','discount'];
  var SHEET_QUALITY_HINT_FIELDS = ['quality','panel','screen'];
  var SHEET_CTA_HINT_FIELDS = ['cta','button','action','primary'];

  function normalizeFieldKey(name){
    return (name || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
  }

  function parseCsv(text){
    if(!text){
      return [];
    }
    var rows = [];
    var current = [];
    var value = '';
    var inQuotes = false;
    for(var i = 0; i < text.length; i++){
      var char = text.charAt(i);
      if(inQuotes){
        if(char === '"'){
          if(i + 1 < text.length && text.charAt(i + 1) === '"'){
            value += '"';
            i++;
          } else {
            inQuotes = false;
          }
        } else {
          value += char;
        }
      } else {
        if(char === '"'){
          inQuotes = true;
        } else if(char === ','){
          current.push(value);
          value = '';
        } else if(char === '\r' || char === '\n'){
          current.push(value);
          value = '';
          if(char === '\r' && i + 1 < text.length && text.charAt(i + 1) === '\n'){
            i++;
          }
          rows.push(current);
          current = [];
        } else {
          value += char;
        }
      }
    }
    current.push(value);
    rows.push(current);
    return rows;
  }

  function normalizeHeaderName(value, index, counts){
    var base = normalizeFieldKey(value);
    if(!base){
      base = 'column_' + index;
    }
    if(Object.prototype.hasOwnProperty.call(counts, base)){
      counts[base] += 1;
      base = base + '_' + counts[base];
    } else {
      counts[base] = 0;
    }
    return base;
  }

  function buildSheetRows(csvText){
    var table = parseCsv(csvText);
    if(!table.length){
      return [];
    }
    var counts = {};
    var headers = table[0].map(function(cell, idx){ return normalizeHeaderName(cell, idx, counts); });
    var rows = [];
    for(var i = 1; i < table.length; i++){
      var cells = table[i];
      if(!cells){
        continue;
      }
      var row = { __index: i };
      var empty = true;
      for(var j = 0; j < headers.length; j++){
        var header = headers[j];
        if(!header){
          continue;
        }
        var cell = cells[j];
        var value = cell === null || typeof cell === 'undefined' ? '' : String(cell).trim();
        if(value){
          empty = false;
        }
        row[header] = value;
      }
      if(!empty){
        rows.push(row);
      }
    }
    return rows;
  }

  function getField(row, aliases){
    if(!row || !aliases){
      return '';
    }
    for(var i = 0; i < aliases.length; i++){
      var key = normalizeFieldKey(aliases[i]);
      if(key && Object.prototype.hasOwnProperty.call(row, key) && row[key] !== ''){
        return row[key];
      }
    }
    return '';
  }

  function parseNumber(value){
    if(value === null || typeof value === 'undefined' || value === ''){
      return NaN;
    }
    if(typeof value === 'number'){
      return value;
    }
    var str = String(value).trim().replace(/[^0-9.+-]/g, '');
    if(!str){
      return NaN;
    }
    var num = parseFloat(str);
    return isFinite(num) ? num : NaN;
  }

  function parseCurrency(value){
    return parseNumber(value);
  }

  function parseBoolean(value){
    if(value === null || typeof value === 'undefined'){
      return null;
    }
    var str = String(value).trim().toLowerCase();
    if(!str){
      return null;
    }
    if(['y','yes','true','1','enabled','active','show','visible','on'].indexOf(str) !== -1){
      return true;
    }
    if(['n','no','false','0','disabled','inactive','hide','hidden','off'].indexOf(str) !== -1){
      return false;
    }
    return null;
  }

  function parseList(value){
    if(value === null || typeof value === 'undefined'){
      return null;
    }
    var str = String(value).trim();
    if(!str){
      return null;
    }
    var parts = str.split(/[;,\/]+/).map(function(part){ return part.trim(); }).filter(Boolean);
    return parts.length ? parts : null;
  }

  function parseOledValue(value){
    if(value === null || typeof value === 'undefined'){
      return undefined;
    }
    var str = String(value).trim();
    if(!str){
      return undefined;
    }
    var lower = str.toLowerCase();
    if(['n/a','na','none','no','false'].indexOf(lower) !== -1){
      return null;
    }
    var amount = parseCurrency(str);
    if(isFinite(amount)){
      return amount;
    }
    return undefined;
  }

  function slugify(value, fallback){
    var base = (value || fallback || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'');
    if(!base){
      base = 'option';
    }
    return base;
  }

  function hasAny(row, fields){
    for(var i = 0; i < fields.length; i++){
      var key = normalizeFieldKey(fields[i]);
      if(key && Object.prototype.hasOwnProperty.call(row, key) && row[key] !== ''){
        return true;
      }
    }
    return false;
  }

  function normalizeSectionValue(value){
    var str = (value || '').toString().trim().toLowerCase();
    if(!str){
      return '';
    }
    if(str.indexOf('model') === 0){ return 'model'; }
    if(str.indexOf('priority') === 0){ return 'priority'; }
    if(str.indexOf('addon') === 0 || str.indexOf('add_on') === 0){ return 'addon'; }
    if(str.indexOf('tier') === 0){ return 'tier'; }
    if(str.indexOf('quality') === 0){ return 'quality'; }
    if(str.indexOf('cta') === 0 || str.indexOf('button') === 0){ return 'cta'; }
    if(str.indexOf('copy') === 0){ return 'copy'; }
    return str;
  }

  function inferSectionFromRow(row){
    if(hasAny(row, SHEET_MODEL_HINT_FIELDS)){ return 'model'; }
    if(hasAny(row, SHEET_PRIORITY_HINT_FIELDS)){ return 'priority'; }
    if(hasAny(row, SHEET_ADDON_HINT_FIELDS)){ return 'addon'; }
    if(hasAny(row, SHEET_TIER_HINT_FIELDS)){ return 'tier'; }
    if(hasAny(row, SHEET_QUALITY_HINT_FIELDS)){ return 'quality'; }
    if(hasAny(row, SHEET_CTA_HINT_FIELDS)){ return 'cta'; }
    return '';
  }

  function parseSheetModel(row){
    var enabled = parseBoolean(getField(row, SHEET_ENABLED_FIELDS));
    if(enabled === false){
      return null;
    }
    var label = getField(row, SHEET_LABEL_FIELDS) || getField(row, ['model','model_label']);
    if(!label){
      return null;
    }
    var id = getField(row, SHEET_KEY_FIELDS) || label;
    id = id.trim();
    var payloadRaw = getField(row, SHEET_PAYLOAD_FIELDS);
    var payload = payloadRaw ? payloadRaw.trim() : '';
    var sortValue = parseNumber(getField(row, SHEET_SORT_FIELDS));
    var family = parseList(getField(row, SHEET_FAMILY_FIELDS));
    var betterPrice = parseCurrency(getField(row, SHEET_BASE_FIELDS));
    var goodPrice = parseCurrency(getField(row, SHEET_GOOD_FIELDS));
    var premiumPrice = parseCurrency(getField(row, SHEET_PREMIUM_FIELDS));
    var goodDiff = parseCurrency(getField(row, SHEET_GOOD_DIFF_FIELDS));
    var premiumDiff = parseCurrency(getField(row, SHEET_PREMIUM_DIFF_FIELDS));
    if(!isFinite(goodPrice) && isFinite(goodDiff) && isFinite(betterPrice)){
      goodPrice = betterPrice + goodDiff;
    }
    if(!isFinite(premiumPrice) && isFinite(premiumDiff) && isFinite(betterPrice)){
      premiumPrice = betterPrice + premiumDiff;
    }
    var key = payload ? payload : id;
    var pricing = {};
    if(isFinite(goodPrice)){ pricing.good = goodPrice; }
    if(isFinite(betterPrice)){ pricing.better = betterPrice; }
    if(isFinite(premiumPrice)){ pricing.premium = premiumPrice; }
    var oledValue = parseOledValue(getField(row, SHEET_OLED_FIELDS));
    return {
      key: key,
      base: isFinite(betterPrice) ? betterPrice : null,
      pricing: pricing,
      oled: oledValue,
      output: {
        id: id,
        label: label,
        payload: payload && payload !== id ? payload : undefined,
        family: family || undefined,
        __sort: isFinite(sortValue) ? sortValue : null,
        __index: row.__index
      }
    };
  }

  function parseSheetPriority(row){
    var enabled = parseBoolean(getField(row, SHEET_ENABLED_FIELDS));
    if(enabled === false){
      return null;
    }
    var label = getField(row, SHEET_LABEL_FIELDS) || getField(row, ['priority','name']);
    if(!label){
      return null;
    }
    var id = getField(row, SHEET_KEY_FIELDS);
    if(!id){
      id = slugify(label);
    }
    var price = parseCurrency(getField(row, SHEET_PRICE_FIELDS));
    if(!isFinite(price)){
      price = 0;
    }
    var description = getField(row, SHEET_DESCRIPTION_FIELDS);
    var sortValue = parseNumber(getField(row, SHEET_SORT_FIELDS));
    return { id: id, label: label, price: price, description: description || '', __sort: isFinite(sortValue) ? sortValue : null, __index: row.__index };
  }

  function parseSheetAddon(row){
    var enabled = parseBoolean(getField(row, SHEET_ENABLED_FIELDS));
    if(enabled === false){
      return null;
    }
    var label = getField(row, SHEET_LABEL_FIELDS) || getField(row, ['addon','name']);
    if(!label){
      return null;
    }
    var id = getField(row, SHEET_KEY_FIELDS);
    if(!id){
      id = slugify(label);
    }
    var price = parseCurrency(getField(row, SHEET_PRICE_FIELDS));
    if(!isFinite(price)){
      price = 0;
    }
    var description = getField(row, SHEET_DESCRIPTION_FIELDS);
    var sortValue = parseNumber(getField(row, SHEET_SORT_FIELDS));
    return { id: id, label: label, price: price, description: description || '', __sort: isFinite(sortValue) ? sortValue : null, __index: row.__index };
  }

  function applyTierRow(row, dataset){
    var key = normalizeSectionValue(getField(row, SHEET_TIER_FIELDS) || getField(row, SHEET_KEY_FIELDS));
    if(!key){
      key = normalizeSectionValue(getField(row, SHEET_LABEL_FIELDS));
    }
    if(['good','better','premium'].indexOf(key) === -1){
      return;
    }
    var title = getField(row, SHEET_TITLE_FIELDS);
    var copy = getField(row, SHEET_DESCRIPTION_FIELDS);
    var note = getField(row, SHEET_NOTE_FIELDS);
    var diff = parseCurrency(getField(row, SHEET_PRICE_FIELDS));
    if(!isFinite(diff)){
      diff = parseCurrency(getField(row, SHEET_GOOD_DIFF_FIELDS.concat(SHEET_PREMIUM_DIFF_FIELDS)));
    }
    if(isFinite(diff)){
      dataset.tierDiff[key] = diff;
    }
    if(title || copy || note){
      if(!dataset.tierCopy[key]){
        dataset.tierCopy[key] = {};
      }
      if(title){ dataset.tierCopy[key].title = title; }
      if(copy){ dataset.tierCopy[key].copy = copy; }
      if(note){ dataset.tierCopy[key].note = note; }
    }
  }

  function applyQualityRow(row, dataset){
    var rawKey = getField(row, SHEET_QUALITY_FIELDS) || getField(row, SHEET_KEY_FIELDS);
    var key = normalizeSectionValue(rawKey);
    if(key !== 'aftermarket' && key !== 'oled'){
      var lowerLabel = (getField(row, SHEET_LABEL_FIELDS) || '').toLowerCase();
      if(lowerLabel.indexOf('aftermarket') !== -1){ key = 'aftermarket'; }
      if(lowerLabel.indexOf('oled') !== -1){ key = 'oled'; }
    }
    if(key !== 'aftermarket' && key !== 'oled'){
      return;
    }
    if(!dataset.qualityCopy[key]){
      dataset.qualityCopy[key] = {};
    }
    var title = getField(row, SHEET_TITLE_FIELDS);
    var description = getField(row, SHEET_DESCRIPTION_FIELDS);
    var badge = getField(row, ['price_label','badge','label_copy']);
    if(title){ dataset.qualityCopy[key].title = title; }
    if(description){ dataset.qualityCopy[key].description = description; }
    if(badge){ dataset.qualityCopy[key].priceLabel = badge; }
  }

  function applyCtaRow(row, dataset){
    if(!dataset.cta){
      dataset.cta = {};
    }
    var key = normalizeFieldKey(getField(row, SHEET_CTA_FIELDS));
    if(!key){
      key = slugify(getField(row, SHEET_LABEL_FIELDS));
    }
    var value = getField(row, SHEET_LABEL_FIELDS) || getField(row, SHEET_DESCRIPTION_FIELDS);
    if(!key || !value){
      return;
    }
    dataset.cta[key] = value;
  }

  function applyCopyRow(row, dataset){
    if(!dataset.copy){
      dataset.copy = {};
    }
    var keySource = getField(row, SHEET_KEY_FIELDS) || getField(row, SHEET_LABEL_FIELDS);
    var key = normalizeSectionValue(keySource);
    if(!key){
      key = slugify(keySource);
    }
    if(!key){
      return;
    }
    var value = getField(row, SHEET_DESCRIPTION_FIELDS) || getField(row, SHEET_LABEL_FIELDS);
    if(!value){
      return;
    }
    dataset.copy[key] = value;
  }

  function sortByOrder(a, b){
    var aSort = typeof a.__sort === 'number' ? a.__sort : null;
    var bSort = typeof b.__sort === 'number' ? b.__sort : null;
    if(aSort !== null && bSort !== null && aSort !== bSort){
      return aSort - bSort;
    }
    if(aSort !== null){ return -1; }
    if(bSort !== null){ return 1; }
    var aIndex = typeof a.__index === 'number' ? a.__index : 0;
    var bIndex = typeof b.__index === 'number' ? b.__index : 0;
    return aIndex - bIndex;
  }

  function buildDatasetFromRows(rows){
    var dataset = { models: [], baseBetter: {}, tierPricing: {}, oledSurcharge: {}, tierDiff: {}, tierCopy: {}, priorityOptions: [], addonOptions: [], qualityCopy: {}, cta: {}, copy: {} };
    rows.forEach(function(row){
      var section = normalizeSectionValue(getField(row, SHEET_SECTION_FIELDS));
      if(!section){
        section = inferSectionFromRow(row);
      }
      if(section === 'model'){
        var parsedModel = parseSheetModel(row);
        if(parsedModel){
          dataset.models.push(parsedModel.output);
          if(parsedModel.base !== null){
            dataset.baseBetter[parsedModel.key] = parsedModel.base;
          }
          dataset.tierPricing[parsedModel.key] = parsedModel.pricing;
          if(typeof parsedModel.oled !== 'undefined'){
            dataset.oledSurcharge[parsedModel.key] = parsedModel.oled;
          }
        }
      } else if(section === 'priority'){
        var parsedPriority = parseSheetPriority(row);
        if(parsedPriority){
          dataset.priorityOptions.push(parsedPriority);
        }
      } else if(section === 'addon'){
        var parsedAddon = parseSheetAddon(row);
        if(parsedAddon){
          dataset.addonOptions.push(parsedAddon);
        }
      } else if(section === 'tier'){
        applyTierRow(row, dataset);
      } else if(section === 'quality'){
        applyQualityRow(row, dataset);
      } else if(section === 'cta'){
        applyCtaRow(row, dataset);
      } else if(section === 'copy'){
        applyCopyRow(row, dataset);
      }
    });
    dataset.models.sort(sortByOrder);
    dataset.priorityOptions.sort(sortByOrder);
    dataset.addonOptions.sort(sortByOrder);
    dataset.models = dataset.models.map(function(model){ delete model.__sort; delete model.__index; return model; });
    dataset.priorityOptions = dataset.priorityOptions.map(function(item){ delete item.__sort; delete item.__index; return item; });
    dataset.addonOptions = dataset.addonOptions.map(function(item){ delete item.__sort; delete item.__index; return item; });
    return dataset;
  }

  function parseSheetData(csvText){
    try {
      var rows = buildSheetRows(csvText);
      if(!rows.length){
        return null;
      }
      return buildDatasetFromRows(rows);
    } catch(err){
      console.error('Failed to parse sheet data', err);
      return null;
    }
  }

  function captureSelections(){
    var addonsCopy = {};
    if(state.addons){
      Object.keys(state.addons).forEach(function(key){
        if(state.addons[key]){
          addonsCopy[key] = true;
        }
      });
    }
    return {
      modelId: state.model ? state.model.id : null,
      tier: state.tier,
      quality: state.quality,
      priority: state.priority,
      addons: addonsCopy
    };
  }

  function refreshCtaLabels(){
    if(dom.checkoutBtn){
      dom.checkoutBtn.textContent = CTA_TEXT;
    }
    if(dom.floatingCheckoutLabel){
      dom.floatingCheckoutLabel.textContent = CTA_TEXT;
    } else if(dom.floatingCheckoutBtn){
      dom.floatingCheckoutBtn.textContent = CTA_TEXT;
    }
    if(dom.paypalBtnLabel){
      dom.paypalBtnLabel.textContent = CTA_PAYPAL_TEXT;
    } else if(dom.paypalBtn){
      dom.paypalBtn.textContent = CTA_PAYPAL_TEXT;
    }
    if(dom.floatingPayBtn){
      dom.floatingPayBtn.textContent = CTA_PAYPAL_TEXT;
    }
  }

  function setCopyText(element, text){
    if(!element){
      return;
    }
    var value = text;
    if(!value && element === dom.introCopy){
      value = DEFAULT_INTRO;
    } else if(!value && element === dom.legalCopy){
      value = DEFAULT_LEGAL;
    }
    while(element.firstChild){
      element.removeChild(element.firstChild);
    }
    if(!value){
      return;
    }
    String(value).split(/\r?\n+/).forEach(function(line, idx, arr){
      element.appendChild(document.createTextNode(line));
      if(idx < arr.length - 1){
        element.appendChild(document.createElement('br'));
      }
    });
  }

  function renderCopy(){
    setCopyText(dom.introCopy, copyContent.intro);
    setCopyText(dom.legalCopy, copyContent.legal);
  }

  function applyCopyDataset(copyDataset){
    var changed = false;
    Object.keys(copyDataset).forEach(function(key){
      var normalized = normalizeSectionValue(key);
      var value = copyDataset[key];
      if(!value){
        return;
      }
      if(normalized === 'intro' || normalized.indexOf('intro_') === 0 || normalized === 'lead' || normalized === 'headline'){
        copyContent.intro = value;
        changed = true;
      } else if(normalized === 'legal' || normalized.indexOf('legal_') === 0 || normalized === 'disclaimer' || normalized === 'footer' || normalized === 'note' || normalized === 'support' || normalized.indexOf('footer_') === 0){
        copyContent.legal = value;
        changed = true;
      }
    });
    return changed;
  }

  function restoreSelections(snapshot){
    if(!snapshot){
      snapshot = {};
    }
    if(!models.length){
      state.model = null;
      return;
    }
    var modelId = snapshot.modelId && getModelById(snapshot.modelId) ? snapshot.modelId : models[0].id;
    state.model = getModelById(modelId);
    state.tier = tierCopy[snapshot.tier] ? snapshot.tier : 'better';
    if(!priorityOptions.some(function(opt){ return opt.id === snapshot.priority; })){
      state.priority = priorityOptions.length ? priorityOptions[0].id : 'standard';
    } else {
      state.priority = snapshot.priority;
    }
    state.quality = snapshot.quality === 'oled' && isOledAvailableKey(getModelKey()) ? 'oled' : 'aftermarket';
    state.addons = {};
    if(snapshot.addons){
      addonOptions.forEach(function(option){
        if(snapshot.addons[option.id]){
          state.addons[option.id] = true;
        }
      });
    }
    renderSelect();
    renderQuality();
    renderPriority();
    renderAddons();
    ensureQualityAvailability();
    syncTabActive();
    updatePriorityActive();
    updateAddonActive();
    updateSummary();
  }

  function applySheetData(dataset){
    if(!dataset){
      return;
    }
    var snapshot = captureSelections();
    var copyChanged = false;
    if(dataset.models && dataset.models.length){
      models = dataset.models.map(function(model){
        return { id: model.id, label: model.label, payload: model.payload, family: model.family };
      });
    }
    if(dataset.baseBetter && Object.keys(dataset.baseBetter).length){
      baseBetter = Object.assign({}, baseBetter, dataset.baseBetter);
    }
    if(dataset.tierDiff && Object.keys(dataset.tierDiff).length){
      Object.keys(dataset.tierDiff).forEach(function(key){ tierDiff[key] = dataset.tierDiff[key]; });
    }
    if(dataset.tierPricing && Object.keys(dataset.tierPricing).length){
      tierPricing = dataset.tierPricing;
    } else if(dataset.models && dataset.models.length){
      initializeTierPricing();
    }
    if(dataset.oledSurcharge && Object.keys(dataset.oledSurcharge).length){
      oledSurcharge = Object.assign({}, oledSurcharge, dataset.oledSurcharge);
    }
    if(dataset.tierCopy && Object.keys(dataset.tierCopy).length){
      Object.keys(dataset.tierCopy).forEach(function(key){
        if(!tierCopy[key]){ tierCopy[key] = {}; }
        Object.assign(tierCopy[key], dataset.tierCopy[key]);
      });
    }
    if(dataset.qualityCopy && Object.keys(dataset.qualityCopy).length){
      Object.keys(dataset.qualityCopy).forEach(function(key){
        if(!qualityCopy[key]){ qualityCopy[key] = {}; }
        Object.assign(qualityCopy[key], dataset.qualityCopy[key]);
      });
    }
    if(dataset.priorityOptions && dataset.priorityOptions.length){
      priorityOptions = dataset.priorityOptions.map(function(option){
        return { id: option.id, label: option.label, price: option.price, description: option.description };
      });
    }
    if(dataset.addonOptions && dataset.addonOptions.length){
      addonOptions = dataset.addonOptions.map(function(option){
        return { id: option.id, label: option.label, price: option.price, description: option.description };
      });
    }
    var ctaUpdated = false;
    if(dataset.cta){
      if(dataset.cta.primary){ CTA_TEXT = dataset.cta.primary; ctaUpdated = true; }
      if(dataset.cta.paypal){ CTA_PAYPAL_TEXT = dataset.cta.paypal; ctaUpdated = true; }
      if(dataset.cta.loading){ CTA_LOADING_TEXT = dataset.cta.loading; }
      if(dataset.cta.loading_alt){ CTA_LOADING_ALT_TEXT = dataset.cta.loading_alt; }
      if(dataset.cta.paypal_loading){ CTA_PAYPAL_LOADING_TEXT = dataset.cta.paypal_loading; }
    }
    if(dataset.copy && Object.keys(dataset.copy).length){
      copyChanged = applyCopyDataset(dataset.copy);
    }
    restoreSelections(snapshot);
    if(ctaUpdated){
      refreshCtaLabels();
    }
    if(copyChanged){
      renderCopy();
    }
  }

  function loadSheetData(){
    if(!SHEET_URL || typeof fetch !== 'function'){
      return;
    }
    fetch(SHEET_URL, { cache: 'no-store' }).then(function(response){
      if(!response.ok){
        throw new Error('HTTP ' + response.status);
      }
      return response.text();
    }).then(function(text){
      var dataset = parseSheetData(text);
      if(dataset){
        if(typeof window !== 'undefined'){
          try {
            window.npcGbbSheetRaw = text;
            window.npcGbbSheetDataset = dataset;
          } catch(err){}
        }
        applySheetData(dataset);
      }
    }).catch(function(err){
      console.warn('Failed to load pricing sheet', err);
    });
  }


  function getModelById(id){
    for(var i = 0; i < models.length; i++){
      if(models[i].id === id){
        return models[i];
      }
    }
    return models[0];
  }

  function getActiveModel(){
    return state.model || models[0];
  }

  function getModelKey(){
    var model = getActiveModel();
    return model && (model.payload || model.id);
  }

  function getModelLabel(){
    var model = getActiveModel();
    return model && model.label ? model.label : '';
  }

  function getModelFamily(){
    var model = getActiveModel();
    if(model && Array.isArray(model.family)){
      return model.family.slice();
    }
    return null;
  }

  function encodePayloadForUrl(payloadJson){
    if(!payloadJson){
      return '';
    }
    try {
      if(typeof TextEncoder !== 'undefined'){
        var encoder = new TextEncoder();
        var bytes = encoder.encode(payloadJson);
        var binary = '';
        for(var i = 0; i < bytes.length; i++){
          binary += String.fromCharCode(bytes[i]);
        }
        return encodeURIComponent(btoa(binary));
      }
    } catch(err){}
    try {
      return encodeURIComponent(btoa(unescape(encodeURIComponent(payloadJson))));
    } catch(err2){
      try {
        return encodeURIComponent(btoa(payloadJson));
      } catch(err3){
        return encodeURIComponent(payloadJson);
      }
    }
  }

  function getSiteBase(){
    var base = locationOrigin || (locationProtocol + '//' + locationHost);
    if(!base){
      return '';
    }
    return base.replace(/\/$/, '');
  }

  function buildManualCheckoutUrl(mode, payloadJson, payload){
    var normalizedBase = getSiteBase();
    if(!normalizedBase){
      return '';
    }
    var url = normalizedBase + '/checkout/?add-to-cart=' + PRODUCT_ID;
    var encodedPayload = encodePayloadForUrl(payloadJson);
    if(encodedPayload){
      url += '&gbb_payload=' + encodedPayload;
      url += '&npc_gbb_payload=' + encodedPayload;
    }
    if(payloadJson){
      url += '&payload=' + encodeURIComponent(payloadJson);
    }
    if(payload){
      var totals = payload.totals || payload.pricing || {};
      var basePrice = Number(totals.base || payload.base_price || 0);
      var qualityPrice = Number(totals.quality || payload.quality_price || 0);
      var priorityPrice = Number(totals.priority || payload.priority_price || payload.priority_amount || 0);
      var addonsPrice = Number(totals.addons || payload.addons_total || 0);
      var totalPrice = Number(totals.total || payload.total_price || payload.total || 0);
      if(!isFinite(basePrice)) basePrice = 0;
      if(!isFinite(qualityPrice)) qualityPrice = 0;
      if(!isFinite(priorityPrice)) priorityPrice = 0;
      if(!isFinite(addonsPrice)) addonsPrice = 0;
      if(!isFinite(totalPrice)) totalPrice = basePrice + qualityPrice + priorityPrice + addonsPrice;
      var centsTotal = toCents(totalPrice);
      var centsBase = toCents(basePrice);
      var centsQuality = toCents(qualityPrice);
      var centsPriority = toCents(priorityPrice);
      var centsAddons = toCents(addonsPrice);
      var totalFormatted = typeof payload.total_formatted === 'string' ? payload.total_formatted : money(totalPrice);
      var prioritySelection = payload.priority_selection || (payload.configuration && payload.configuration.priority_selection) || payload.priority || '';
      var priorityLabel = payload.priority_label || (payload.configuration && payload.configuration.priority_label) || '';
      var modelLabel = payload.model_label || (payload.configuration && payload.configuration.model_label) || '';
      var modelKey = payload.model || (payload.configuration && payload.configuration.model) || '';
      var tierKey = payload.tier || (payload.configuration && payload.configuration.tier) || '';
      var qualityKey = payload.quality || (payload.configuration && payload.configuration.quality) || '';
      url += '&gbb_model=' + encodeURIComponent(modelKey);
      url += '&gbb_model_label=' + encodeURIComponent(modelLabel);
      url += '&gbb_tier=' + encodeURIComponent(tierKey);
      url += '&gbb_quality=' + encodeURIComponent(qualityKey);
      if(prioritySelection){
        url += '&gbb_priority_selection=' + encodeURIComponent(prioritySelection);
      }
      if(priorityLabel){
        url += '&gbb_priority_label=' + encodeURIComponent(priorityLabel);
      }
      url += '&gbb_total=' + encodeURIComponent(totalPrice.toFixed(2));
      url += '&gbb_total_cents=' + encodeURIComponent(centsTotal);
      url += '&gbb_total_display=' + encodeURIComponent(totalFormatted);
      url += '&gbb_base=' + encodeURIComponent(basePrice.toFixed(2));
      url += '&gbb_quality=' + encodeURIComponent(qualityPrice.toFixed(2));
      url += '&gbb_priority_amount=' + encodeURIComponent(priorityPrice.toFixed(2));
      url += '&gbb_priority=' + encodeURIComponent(priorityPrice.toFixed(2));
      url += '&gbb_addons=' + encodeURIComponent(addonsPrice.toFixed(2));
      url += '&gbb_addons_total=' + encodeURIComponent(addonsPrice.toFixed(2));
      if(payload.addons && payload.addons.length){
        url += '&gbb_addons_selected=' + encodeURIComponent(payload.addons.join(', '));
      }
      url += '&gbb_breakdown_cents=' + encodeURIComponent(JSON.stringify({ base: centsBase, quality: centsQuality, priority: centsPriority, addons: centsAddons, total: centsTotal }));
    }
    if(mode && mode !== 'checkout'){
      url += '&checkout_mode=' + encodeURIComponent(mode);
    }
    url += '&gbb_mode=' + encodeURIComponent(mode || 'checkout');
    return url;
  }

  function normalizePotentialUrl(value, fallbackBase){
    if(!value || typeof value !== 'string'){
      return '';
    }
    var trimmed = value.trim();
    if(!trimmed || /\s/.test(trimmed)){
      return '';
    }
    if(/^https?:\/\//i.test(trimmed)){
      return trimmed;
    }
    if(trimmed.indexOf('//') === 0){
      return (locationProtocol || 'https:') + trimmed;
    }
    if(trimmed.charAt(0) === '/' && fallbackBase){
      return fallbackBase.replace(/\/$/, '') + trimmed;
    }
    if(trimmed.charAt(0) === '?' && fallbackBase){
      return fallbackBase.replace(/\/$/, '') + '/' + trimmed;
    }
    if(fallbackBase && /^[A-Za-z0-9._~!$&'()*+,;=:@/?-]+$/.test(trimmed)){
      return fallbackBase.replace(/\/$/, '') + '/' + trimmed.replace(/^\/+/, '');
    }
    return '';
  }

  function getCheckoutEndpoints(mode){
    var normalizedBase = getSiteBase();
    if(!normalizedBase){
      return [];
    }
    var endpoints = [];
    var seen = {};
    var jsonEndpoints = [
      normalizedBase + '/wp-json/npc-gbb/v1/checkout',
      normalizedBase + '/wp-json/npc/v1/gbb/checkout',
      normalizedBase + '/wp-json/npc-gbb/v1/checkout?mode=' + encodeURIComponent(mode || 'checkout'),
      normalizedBase + '/wp-json/npc/v1/gbb/checkout?mode=' + encodeURIComponent(mode || 'checkout')
    ];
    for(var i = 0; i < jsonEndpoints.length; i++){
      var url = jsonEndpoints[i];
      if(!seen[url]){
        endpoints.push({ url: url, type: 'json' });
        seen[url] = true;
      }
    }
    var ajaxEndpoints = [
      normalizedBase + '/wp-admin/admin-ajax.php',
      normalizedBase + '/wp-admin/admin-ajax.php?action=npc_gbb_checkout'
    ];
    for(var j = 0; j < ajaxEndpoints.length; j++){
      var ajaxUrl = ajaxEndpoints[j];
      if(!seen[ajaxUrl]){
        endpoints.push({ url: ajaxUrl, type: 'form' });
        seen[ajaxUrl] = true;
      }
    }
    return endpoints;
  }

  function offerManualCheckout(payloadJson, mode, message, payload){
    if(!dom.checkoutStatus){
      return '';
    }
    var manualUrl = buildManualCheckoutUrl(mode, payloadJson, payload);
    if(!manualUrl){
      return '';
    }
    dom.checkoutStatus.classList.remove('hidden', 'success');
    dom.checkoutStatus.classList.add('error');
    dom.checkoutStatus.textContent = '';
    var note = document.createElement('span');
    var prefix = message ? message + ' ' : 'We could not reach checkout automatically. ';
    var modeCopy = mode === 'paypal' ? 'We\'re opening the secure Lowbies.com checkout instead.' : 'We\'re opening the secure checkout page for you now.';
    note.textContent = prefix + modeCopy + ' ';
    var link = document.createElement('a');
    link.href = manualUrl;
    link.target = '_blank';
    link.rel = 'noopener';
    link.textContent = 'Open checkout manually on Lowbies.com';
    dom.checkoutStatus.appendChild(note);
    dom.checkoutStatus.appendChild(link);
    dom.checkoutStatus.appendChild(document.createTextNode('.'));
    return manualUrl;
  }

  function parseRedirect(response, fallbackBase){
    if(!response){
      return '';
    }
    var data = response;
    if(typeof response === 'string'){
      try {
        data = JSON.parse(response);
      } catch(err){
        var match = response.match(/https?:\/\/[^"'\s<>]+/);
        if(match && match[0]){
          return match[0];
        }
        return '';
      }
    }
    if(data && typeof data === 'object'){
      var direct = normalizePotentialUrl(data.redirect, fallbackBase);
      if(direct){
        return direct;
      }
      direct = normalizePotentialUrl(data.url, fallbackBase);
      if(direct){
        return direct;
      }
      if(data.data){
        if(typeof data.data === 'string'){
          var nested = normalizePotentialUrl(data.data, fallbackBase);
          if(nested){
            return nested;
          }
        }
        if(data.data && typeof data.data === 'object'){
          var nestedRedirect = normalizePotentialUrl(data.data.redirect, fallbackBase) || normalizePotentialUrl(data.data.url, fallbackBase);
          if(nestedRedirect){
            return nestedRedirect;
          }
        }
      }
    }
    if(fallbackBase && data && data.path){
      var viaPath = normalizePotentialUrl(String(data.path), fallbackBase);
      if(viaPath){
        return viaPath;
      }
    }
    return '';
  }

  function redirectTo(url, mode, payloadJson, payload){
    if(!url){
      return false;
    }
    var finalUrl = url;
    if(url.charAt(0) === '/' && getSiteBase()){
      finalUrl = getSiteBase() + url;
    }
    var statusCopy = mode === 'paypal' ? 'Opening secure Lowbies.com checkout…' : 'Redirecting you to secure checkout…';
    showStatus(statusCopy, 'success');
    setTimeout(function(){
      try {
        window.location.href = finalUrl;
      } catch(err){
        console.error('Checkout redirect failed', err);
        showStatus('We could not open checkout automatically. Please use the link below.', 'error');
        offerManualCheckout(payloadJson, mode, statusCopy, payload);
        setLoading(false);
      }
    }, 150);
    return true;
  }



  function renderSelect(){
    if(!dom.modelSelect){
      return;
    }
    var selectedId = state.model ? state.model.id : (models[0] && models[0].id);
    dom.modelSelect.innerHTML = '';
    var frag = document.createDocumentFragment();
    models.forEach(function(model){
      var option = document.createElement('option');
      option.value = model.id;
      option.textContent = model.label;
      if(selectedId && model.id === selectedId){
        option.selected = true;
      }
      frag.appendChild(option);
    });
    dom.modelSelect.appendChild(frag);
    if(selectedId){
      dom.modelSelect.value = selectedId;
    }
  }



  function renderQuality(){
    var container = dom.qualityOptions;
    if(!container){
      return;
    }
    container.innerHTML = '';
    var aftermarket = document.createElement('div');
    var aftermarketActive = state.quality !== 'oled';
    aftermarket.className = 'radio-item' + (aftermarketActive ? ' active' : '');
    var aftermarketHtml = [
      '<input type="radio" name="quality" value="aftermarket" id="quality-aftermarket"' + (aftermarketActive ? ' checked' : '') + '>',
      '  <label for="quality-aftermarket">',
      '    <div class="row"><strong>' + qualityCopy.aftermarket.title + '</strong><span class="price-chip">' + (qualityCopy.aftermarket.priceLabel || 'Included') + '</span></div>',
      '    <div class="hint">' + qualityCopy.aftermarket.description + '</div>',
      '  </label>'
    ].join('
');
    aftermarket.innerHTML = aftermarketHtml;
    container.appendChild(aftermarket);

    var oled = document.createElement('div');
    var oledActive = state.quality === 'oled';
    oled.className = 'radio-item' + (oledActive ? ' active' : '');
    var oledHtml = [
      '<input type="radio" name="quality" value="oled" id="quality-oled"' + (oledActive ? ' checked' : '') + '>',
      '  <label for="quality-oled">',
      '    <div class="row"><strong>' + qualityCopy.oled.title + '</strong><span class="price-chip" id="oledPrice">' + (qualityCopy.oled.priceLabel || '(+ $0)') + '</span></div>',
      '    <div class="hint">' + qualityCopy.oled.description + '</div>',
      '  </label>'
    ].join('
');
    oled.innerHTML = oledHtml;
    container.appendChild(oled);
  }



  function renderPriority(){
    var container = dom.priorityOptions;
    if(!container){
      return;
    }
    container.innerHTML = '';
    var selected = state.priority || (priorityOptions[0] && priorityOptions[0].id);
    priorityOptions.forEach(function(option, idx){
      var item = document.createElement('div');
      var isActive = option.id === selected || (!selected && idx === 0);
      item.className = 'radio-item' + (isActive ? ' active' : '');
      var inputId = 'priority-' + option.id;
      var markup = [
        '<input type="radio" name="priority" value="' + option.id + '" id="' + inputId + '"' + (isActive ? ' checked' : '') + '>',
        '  <label for="' + inputId + '">',
        '    <div class="row"><strong>' + option.label + '</strong><span class="price-chip">' + (option.price ? money(option.price) : 'Included') + '</span></div>',
        '    <div class="hint">' + (option.description || '') + '</div>',
        '  </label>'
      ].join('
');
      item.innerHTML = markup;
      container.appendChild(item);
    });
  }



  function renderAddons(){
    var container = dom.addonOptions;
    if(!container){
      return;
    }
    container.innerHTML = '';
    addonOptions.forEach(function(option){
      var wrapper = document.createElement('div');
      wrapper.className = 'check-item';
      var inputId = 'addon-' + option.id;
      var isChecked = !!state.addons[option.id];
      var markup = [
        '<input type="checkbox" id="' + inputId + '" value="' + option.id + '"' + (isChecked ? ' checked' : '') + '>',
        '  <label for="' + inputId + '">',
        '    <div class="row"><strong>' + option.label + '</strong><span class="price-chip">' + money(option.price) + '</span></div>',
        '    <div class="hint">' + (option.description || '') + '</div>',
        '  </label>'
      ].join('
');
      wrapper.innerHTML = markup;
      container.appendChild(wrapper);
    });
    bindAddonCheckboxes();
  }

  function bindAddonCheckboxes(){
    addonOptions.forEach(function(option){
      var checkbox = $('addon-' + option.id);
      if(!checkbox){
        return;
      }
      checkbox.addEventListener('change', function(){
        if(this.checked){
          state.addons[option.id] = true;
        } else {
          delete state.addons[option.id];
        }
        updateSummary();
      });
    });
  }

  function syncTabActive(){
    ['good','better','premium'].forEach(function(tier){
      var tab = $('tab-' + tier);
      if(!tab) return;
      if(state.tier === tier){
        tab.classList.add('active');
        tab.setAttribute('aria-selected','true');
      } else {
        tab.classList.remove('active');
        tab.setAttribute('aria-selected','false');
      }
    });
    var copy = tierCopy[state.tier];
    $('tierIndicatorTitle').textContent = copy.title;
    $('tierIndicatorCopy').textContent = copy.copy;
    dom.warrantyNote.textContent = copy.note;
    $('summaryTier').textContent = copy.title;
  }

  function getPriorityPrice(){
    var selected = priorityOptions.find(function(opt){ return opt.id === state.priority; });
    return selected ? selected.price : 0;
  }

  function getSelectedAddonDetails(){
    return addonOptions.filter(function(option){
      return !!state.addons[option.id];
    }).map(function(option){
      return { id: option.id, label: option.label, price: option.price };
    });
  }

  function getAddonPrice(){
    var items = getSelectedAddonDetails();
    var total = 0;
    for(var i = 0; i < items.length; i++){
      total += Number(items[i].price || 0);
    }
    return total;
  }

  function buildAddonList(){
    return getSelectedAddonDetails().map(function(item){ return item.label; });
  }

  function isOledAvailableKey(modelKey){
    if(typeof modelKey === 'undefined' || modelKey === null){
      return false;
    }
    if(!Object.prototype.hasOwnProperty.call(oledSurcharge, modelKey)){
      return false;
    }
    return oledSurcharge[modelKey] !== null;
  }

  function ensureQualityAvailability(){
    var modelKey = getModelKey();
    var available = isOledAvailableKey(modelKey);
    var oledInput = $('quality-oled');
    if(!available){
      oledInput.checked = false;
      oledInput.disabled = true;
      state.quality = 'aftermarket';
      $('quality-aftermarket').checked = true;
      $('oledPrice').textContent = '(N/A)';
    } else {
      oledInput.disabled = false;
      $('oledPrice').textContent = '(+ ' + money(oledSurcharge[modelKey]) + ')';
    }
    updateQualityActive();
  }

  function updateQualityActive(){
    var items = dom.qualityOptions.querySelectorAll('.radio-item');
    items.forEach(function(item){ item.classList.remove('active'); });
    var selector = state.quality === 'oled' ? 'quality-oled' : 'quality-aftermarket';
    var selectedItem = dom.qualityOptions.querySelector('input#' + selector);
    if(selectedItem){
      selectedItem.parentElement.classList.add('active');
    }
  }

  function updatePriorityActive(){
    if(priorityOptions.length && !priorityOptions.some(function(opt){ return opt.id === state.priority; })){
      state.priority = priorityOptions[0].id;
    }
    var inputs = dom.priorityOptions.querySelectorAll('input[name="priority"]');
    inputs.forEach(function(input){
      if(input.value === state.priority){
        input.checked = true;
        input.parentElement.classList.add('active');
      } else {
        input.parentElement.classList.remove('active');
      }
    });
  }

  function updateAddonActive(){
    addonOptions.forEach(function(option){
      var checkbox = $('addon-' + option.id);
      if(!checkbox) return;
      checkbox.checked = !!state.addons[option.id];
    });
  }

  function basePrice(){
    var modelKey = getModelKey();
    var pricing = getTierPricingForKey(modelKey);
    if(pricing && Object.prototype.hasOwnProperty.call(pricing, state.tier)){
      var value = Number(pricing[state.tier]);
      return isFinite(value) ? value : 0;
    }
    var better = Number(baseBetter[modelKey] || 0);
    if(!isFinite(better)) better = 0;
    var diff = Number(tierDiff[state.tier] || 0);
    if(!isFinite(diff)) diff = 0;
    return better + diff;
  }

  function qualityPrice(){
    if(state.quality !== 'oled') return 0;
    var modelKey = getModelKey();
    return oledSurcharge[modelKey] || 0;
  }

  function computeTotals(){
    var base = basePrice();
    var quality = qualityPrice();
    var priority = getPriorityPrice();
    var addons = getAddonPrice();
    var total = base + quality + priority + addons;
    return { base: base, quality: quality, priority: priority, addons: addons, total: total };
  }

  function updateSummary(){
    dom.summaryModel.textContent = getModelLabel();
    dom.summaryQuality.textContent = state.quality === 'oled' ? 'OEM-Match OLED' : 'Premium Aftermarket';
    var priorityOption = priorityOptions.find(function(opt){ return opt.id === state.priority; });
    dom.summaryPriority.textContent = priorityOption ? priorityOption.label + (priorityOption.price ? ' — ' + money(priorityOption.price) : ' — Included') : 'Standard Queue';
    var addonList = buildAddonList();
    dom.summaryAddons.textContent = addonList.length ? addonList.join(', ') : 'None';
    var totals = computeTotals();
    dom.priceBase.textContent = money(totals.base);
    dom.priceQuality.textContent = money(totals.quality);
    dom.pricePriority.textContent = money(totals.priority);
    dom.priceAddons.textContent = money(totals.addons);
    dom.priceTotal.textContent = money(totals.total);
    if(dom.floatingTotalAmount){
      dom.floatingTotalAmount.textContent = money(totals.total);
    }
    updateTierIndicatorMath();
    dom.summaryWarranty.textContent = tierCopy[state.tier].note;
  }

  function resetState(){
    state.model = models.length ? models[0] : null;
    state.tier = 'better';
    state.quality = 'aftermarket';
    state.priority = priorityOptions.length ? priorityOptions[0].id : 'standard';
    state.addons = {};
    if(state.model){
      dom.modelSelect.value = state.model.id;
    }
    ensureQualityAvailability();
    syncTabActive();
    updatePriorityActive();
    updateAddonActive();
    updateSummary();
  }

  function attachEvents(){
    ['tab-good','tab-better','tab-premium'].forEach(function(tabId){
      var tab = $(tabId);
      if(!tab) return;
      tab.addEventListener('click', function(){
        state.tier = tab.dataset.tier;
        syncTabActive();
        updateSummary();
      });
      tab.addEventListener('keydown', function(evt){
        if(evt.key === 'Enter' || evt.key === ' '){ evt.preventDefault(); tab.click(); }
      });
    });

    dom.modelSelect.addEventListener('change', function(){
      state.model = getModelById(this.value);
      ensureQualityAvailability();
      updateSummary();
    });

    dom.qualityOptions.addEventListener('change', function(evt){
      if(evt.target && evt.target.name === 'quality'){
        state.quality = evt.target.value;
        updateQualityActive();
        updateSummary();
      }
    });

    dom.priorityOptions.addEventListener('change', function(evt){
      if(evt.target && evt.target.name === 'priority'){
        state.priority = evt.target.value;
        updatePriorityActive();
        updateSummary();
      }
    });

    dom.resetBtn.addEventListener('click', function(){
      resetState();
      showStatus('Selections reset.', 'success');
    });

    dom.checkoutBtn.addEventListener('click', function(){ submitCheckout('checkout'); });
    if(dom.paypalBtn){
      dom.paypalBtn.addEventListener('click', function(){ submitCheckout('paypal'); });
    }
    if(dom.floatingCheckoutBtn){
      dom.floatingCheckoutBtn.addEventListener('click', function(){ submitCheckout('checkout'); });
    }
    if(dom.floatingPayBtn){
      dom.floatingPayBtn.addEventListener('click', function(){ submitCheckout('paypal'); });
    }
  }

  function showStatus(message, type){
    dom.checkoutStatus.textContent = message;
    dom.checkoutStatus.classList.remove('hidden','error','success');
    dom.checkoutStatus.classList.add(type === 'error' ? 'error' : 'success');
  }

  function clearStatus(){
    dom.checkoutStatus.classList.add('hidden');
    dom.checkoutStatus.textContent = '';
    dom.checkoutStatus.classList.remove('error','success');
  }

  function setLoading(loading, mode){
    if(loading){
      dom.checkoutBtn.setAttribute('disabled','disabled');
      dom.checkoutBtn.textContent = mode === 'paypal' ? CTA_LOADING_ALT_TEXT : CTA_LOADING_TEXT;
      if(dom.paypalBtn){
        dom.paypalBtn.setAttribute('disabled','disabled');
        if(dom.paypalBtnLabel){
          dom.paypalBtnLabel.textContent = mode === 'paypal' ? CTA_PAYPAL_LOADING_TEXT : CTA_LOADING_ALT_TEXT;
        } else {
          dom.paypalBtn.textContent = mode === 'paypal' ? CTA_PAYPAL_LOADING_TEXT : CTA_LOADING_ALT_TEXT;
        }
      }
      if(dom.floatingCheckoutBtn){
        dom.floatingCheckoutBtn.setAttribute('disabled','disabled');
      }
      if(dom.floatingCheckoutLabel){
        dom.floatingCheckoutLabel.textContent = mode === 'paypal' ? CTA_LOADING_ALT_TEXT : CTA_LOADING_TEXT;
      }
      if(dom.floatingPayBtn){
        dom.floatingPayBtn.setAttribute('disabled','disabled');
        dom.floatingPayBtn.textContent = mode === 'paypal' ? CTA_PAYPAL_LOADING_TEXT : CTA_LOADING_ALT_TEXT;
      }
    } else {
      dom.checkoutBtn.removeAttribute('disabled');
      dom.checkoutBtn.textContent = CTA_TEXT;
      if(dom.paypalBtn){
        dom.paypalBtn.removeAttribute('disabled');
        if(dom.paypalBtnLabel){
          dom.paypalBtnLabel.textContent = CTA_PAYPAL_TEXT;
        } else {
          dom.paypalBtn.textContent = CTA_PAYPAL_TEXT;
        }
      }
      if(dom.floatingCheckoutBtn){
        dom.floatingCheckoutBtn.removeAttribute('disabled');
      }
      if(dom.floatingCheckoutLabel){
        dom.floatingCheckoutLabel.textContent = CTA_TEXT;
      }
      if(dom.floatingPayBtn){
        dom.floatingPayBtn.removeAttribute('disabled');
        dom.floatingPayBtn.textContent = CTA_PAYPAL_TEXT;
      }
    }
  }

  function buildPayload(mode){
    var totals = computeTotals();
    var model = getActiveModel();
    var modelKey = getModelKey();
    var addonDetails = getSelectedAddonDetails();
    var addonLabels = addonDetails.map(function(item){ return item.label; });
    var addonIds = addonDetails.map(function(item){ return item.id; });
    var priorityOption = priorityOptions.find(function(opt){ return opt.id === state.priority; });
    var priorityKey = priorityOption ? priorityOption.id : state.priority;
    var priorityAmount = priorityOption ? priorityOption.price : 0;
    var priorityLabel = priorityOption ? priorityOption.label : 'Standard Queue';
    var modelValue = model ? (model.payload || model.id) : null;
    var modelId = model ? model.id : null;
    var totalsCents = {
      base: toCents(totals.base),
      quality: toCents(totals.quality),
      priority: toCents(totals.priority),
      addons: toCents(totals.addons),
      total: toCents(totals.total)
    };
    var lineItems = [];
    lineItems.push({
      key: 'base',
      label: 'Screen repair (' + getModelLabel() + ')',
      tier: state.tier,
      amount: totals.base,
      amount_cents: totalsCents.base,
      amount_formatted: money(totals.base)
    });
    if(state.quality === 'oled' && totals.quality){
      lineItems.push({
        key: 'quality',
        label: 'OLED upgrade',
        amount: totals.quality,
        amount_cents: totalsCents.quality,
        amount_formatted: money(totals.quality)
      });
    }
    if(priorityAmount){
      lineItems.push({
        key: 'priority',
        label: priorityLabel || 'Priority service',
        amount: totals.priority,
        amount_cents: totalsCents.priority,
        amount_formatted: money(totals.priority)
      });
    }
    if(addonDetails.length){
      addonDetails.forEach(function(item){
        lineItems.push({
          key: 'addon_' + item.id,
          label: item.label,
          amount: Number(item.price || 0),
          amount_cents: toCents(item.price),
          amount_formatted: money(item.price)
        });
      });
    }
    var configuration = {
      product_id: PRODUCT_ID,
      model: modelKey,
      model_key: modelId,
      model_id: modelId,
      model_label: getModelLabel(),
      model_display: getModelLabel(),
      model_value: modelValue,
      model_selection: modelId,
      tier: state.tier,
      tier_key: state.tier,
      tier_label: tierCopy[state.tier].title,
      tier_note: tierCopy[state.tier].note,
      quality: state.quality,
      quality_option: state.quality,
      quality_label: state.quality === 'oled' ? 'OEM-Match OLED' : 'Premium Aftermarket',
      quality_price: totals.quality,
      quality_price_cents: totalsCents.quality,
      quality_price_formatted: money(totals.quality || 0),
      priority: priorityKey,
      priority_id: priorityKey,
      priority_key: priorityKey,
      priority_label: priorityLabel,
      priority_price: priorityAmount,
      priority_amount: priorityAmount,
      priority_value: priorityAmount,
      priority_price_formatted: money(priorityAmount || 0),
      priority_selection: priorityKey,
      priority_selection_label: priorityLabel,
      addons: addonLabels,
      addons_detail: addonDetails,
      addon_ids: addonIds,
      addons_total: totals.addons,
      addons_total_cents: totalsCents.addons,
      addons_total_formatted: money(totals.addons || 0),
      pricing: totals,
      pricing_cents: totalsCents,
      line_items: lineItems,
      totals: totals,
      totals_cents: totalsCents,
      total: totals.total,
      total_price: totals.total,
      total_cents: totalsCents.total,
      total_formatted: money(totals.total || 0),
      base_price: totals.base,
      base_price_cents: totalsCents.base,
      base_price_formatted: money(totals.base || 0),
      priority_total: totals.priority,
      priority_total_cents: totalsCents.priority,
      priority_total_formatted: money(totals.priority || 0),
      timestamp: new Date().toISOString(),
      checkout_mode: mode || 'checkout',
      mode: mode || 'checkout'
    };
    var family = getModelFamily();
    if(family){
      configuration.model_family = family;
    }
    if(model && model.payload){
      configuration.model_payload = model.payload;
    }
    return {
      product_id: PRODUCT_ID,
      quantity: 1,
      model: modelKey,
      model_key: modelId,
      model_id: modelId,
      model_label: getModelLabel(),
      model_display: getModelLabel(),
      model_selection: modelId,
      tier: state.tier,
      tier_key: state.tier,
      tier_label: tierCopy[state.tier].title,
      quality: state.quality,
      quality_option: state.quality,
      quality_label: state.quality === 'oled' ? 'OEM-Match OLED' : 'Premium Aftermarket',
      quality_price: totals.quality,
      quality_price_cents: totalsCents.quality,
      quality_price_formatted: money(totals.quality || 0),
      priority: priorityKey,
      priority_id: priorityKey,
      priority_key: priorityKey,
      priority_label: priorityLabel,
      priority_amount: priorityAmount,
      priority_value: priorityAmount,
      priority_price: priorityAmount,
      priority_price_formatted: money(priorityAmount || 0),
      addons: addonLabels,
      addon_ids: addonIds,
      addons_detail: addonDetails,
      addons_total: totals.addons,
      addons_total_cents: totalsCents.addons,
      addons_total_formatted: money(totals.addons || 0),
      totals: totals,
      totals_cents: totalsCents,
      totals_formatted: {
        base: money(totals.base || 0),
        quality: money(totals.quality || 0),
        priority: money(totals.priority || 0),
        addons: money(totals.addons || 0),
        total: money(totals.total || 0)
      },
      pricing: totals,
      pricing_cents: totalsCents,
      total: totals.total,
      total_price: totals.total,
      total_cents: totalsCents.total,
      total_formatted: money(totals.total || 0),
      subtotal: totals.total,
      subtotal_price: totals.total,
      subtotal_cents: totalsCents.total,
      subtotal_formatted: money(totals.total || 0),
      base_price: totals.base,
      base_price_cents: totalsCents.base,
      base_price_formatted: money(totals.base || 0),
      priority_total: totals.priority,
      priority_total_cents: totalsCents.priority,
      priority_total_formatted: money(totals.priority || 0),
      configuration: configuration,
      cart: {
        items: lineItems,
        subtotal: totals.total,
        subtotal_cents: totalsCents.total,
        subtotal_formatted: money(totals.total || 0),
        total: totals.total,
        total_cents: totalsCents.total,
        total_formatted: money(totals.total || 0)
      },
      line_items: lineItems,
      checkout_mode: mode || 'checkout',
      mode: mode || 'checkout',
      priority_selection: priorityKey,
      priority_selection_label: priorityLabel
    };
  }

  function submitCheckout(mode){
    mode = mode || 'checkout';
    clearStatus();
    setLoading(true, mode);
    var payload = buildPayload(mode);
    var payloadJson = JSON.stringify(payload);
    window.gbbPayloadPreview = payload; // Helpful for support/debug via console

    var endpoints = typeof fetch === 'function' ? getCheckoutEndpoints(mode) : [];
    var manualUrl = buildManualCheckoutUrl(mode, payloadJson, payload);

    if(!endpoints.length){
      if(manualUrl){
        redirectTo(manualUrl, mode, payloadJson, payload);
        setTimeout(function(){ setLoading(false); }, 1200);
      } else {
        var fallbackMessage = 'Unable to prepare checkout link. Please contact support.';
        showStatus(fallbackMessage, 'error');
        offerManualCheckout(payloadJson, mode, fallbackMessage, payload);
        setLoading(false);
      }
      return;
    }

    var statusCopy = mode === 'paypal' ? 'Opening secure Lowbies.com checkout…' : 'Contacting Lowbies.com checkout…';
    showStatus(statusCopy, 'success');

    var attempt = function(index){
      if(index >= endpoints.length){
        if(manualUrl){
          redirectTo(manualUrl, mode, payloadJson, payload);
          setTimeout(function(){ setLoading(false); }, 1200);
        } else {
          var fallbackMessage = 'Unable to prepare checkout link. Please contact support.';
          showStatus(fallbackMessage, 'error');
          offerManualCheckout(payloadJson, mode, fallbackMessage, payload);
          setLoading(false);
        }
        return;
      }

      var endpoint = endpoints[index];
      var requestOptions = { method: 'POST', credentials: 'include' };
      if(endpoint.type === 'json'){
        requestOptions.headers = { 'Content-Type': 'application/json' };
        requestOptions.body = payloadJson;
      } else {
        var form = new FormData();
        if(endpoint.url.indexOf('action=') === -1){
          form.append('action', 'npc_gbb_checkout');
        }
        form.append('mode', mode);
        form.append('payload', payloadJson);
        requestOptions.body = form;
      }

      fetch(endpoint.url, requestOptions).then(function(response){
        if(!response.ok){
          throw new Error('HTTP ' + response.status);
        }
        var contentType = response.headers.get('content-type') || '';
        if(contentType.indexOf('application/json') !== -1 || contentType.indexOf('text/json') !== -1){
          return response.json();
        }
        return response.text();
      }).then(function(body){
        var redirectUrl = parseRedirect(body, getSiteBase());
        if(redirectUrl){
          redirectTo(redirectUrl, mode, payloadJson, payload);
          setTimeout(function(){ setLoading(false); }, 1200);
        } else {
          throw new Error('No redirect URL in response');
        }
      }).catch(function(err){
        console.error('Checkout endpoint failed', endpoint.url, err);
        attempt(index + 1);
      });
    };

    attempt(0);
  }

  function cacheDom(){
    dom = {
      modelSelect: $('modelSelect'),
      qualityOptions: $('qualityOptions'),
      priorityOptions: $('priorityOptions'),
      addonOptions: $('addonOptions'),
      summaryModel: $('summaryModel'),
      summaryTier: $('summaryTier'),
      summaryQuality: $('summaryQuality'),
      summaryPriority: $('summaryPriority'),
      summaryAddons: $('summaryAddons'),
      priceBase: $('priceBase'),
      priceQuality: $('priceQuality'),
      pricePriority: $('pricePriority'),
      priceAddons: $('priceAddons'),
      priceTotal: $('priceTotal'),
      floatingCheckoutBtn: $('floatingCheckoutBtn'),
      floatingCheckoutLabel: $('floatingCheckoutLabel'),
      floatingPayBtn: $('floatingPayBtn'),
      floatingTotalAmount: $('floatingTotalAmount'),
      paypalBtn: $('paypalBtn'),
      paypalBtnLabel: $('paypalBtnLabel'),
      summaryWarranty: $('summaryWarranty'),
      warrantyNote: $('warrantyNote'),
      checkoutBtn: $('checkoutBtn'),
      checkoutStatus: $('checkoutStatus'),
      resetBtn: $('resetBtn')
    };
    dom.introCopy = $('introCopy');
    dom.legalCopy = $('legalCopy');
  }

  function init(){
    cacheDom();
    renderCopy();
    renderSelect();
    renderQuality();
    renderPriority();
    renderAddons();
    ensureQualityAvailability();
    syncTabActive();
    updatePriorityActive();
    updateAddonActive();
    updateSummary();
    attachEvents();
    loadSheetData();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
