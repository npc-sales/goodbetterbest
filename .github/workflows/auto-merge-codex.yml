name: Auto-merge Codex PRs (prefer PR version)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto_merge_codex:
    # only act on PRs into main AND carrying the "codex" label
    if: >
      github.event.pull_request.base.ref == 'main' &&
      contains(github.event.pull_request.labels.*.name, 'codex')
    runs-on: ubuntu-latest
    steps:
      - name: Configure git
        run: |
          git config --global user.name  "github-actions"
          git config --global user.email "actions@github.com"

      - name: Checkout base (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch head branch
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          git fetch origin +refs/heads/${HEAD_REF}:refs/remotes/origin/${HEAD_REF}

      # Try a normal merge resolving conflicts in favor of the PR ("theirs")
      - name: Try merge -X theirs
        id: trymerge
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set +e
          git merge -X theirs --no-ff -m "Auto-merge PR #${PR_NUMBER} (prefer PR changes)" origin/${HEAD_REF}
          echo "status=$?" >> $GITHUB_OUTPUT
          set -e

      # If the merge failed for any reason, fall back to file-level overwrite for the paths we care about
      - name: Fallback: take PR versions of allowed files
        if: steps.trymerge.outputs.status != '0'
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -e
          # Overwrite only our deploy-controlled files from the PR
          git checkout origin/${HEAD_REF} -- gbb/index.html || true
          git checkout origin/${HEAD_REF} -- mu-plugins/npc-gbb-bridge.php || true
          if [ -n "$(git status --porcelain)" ]; then
            git add gbb/index.html mu-plugins/npc-gbb-bridge.php 2>/dev/null || true
            git commit -m "Auto-resolve from PR: take PR versions of deploy files"
          fi

      - name: Push to main
        run: |
          # Only push if there is something to push
          if [ -n "$(git log origin/main..HEAD)" ]; then
            git push origin HEAD:main
          else
            echo "Nothing to push."
          fi

      - name: Comment and close PR
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          comment: >
            Auto-applied PR changes to `main` (favoring PR version). PR closed to avoid manual conflict resolution. âœ…
