name: Auto-merge Codex PRs (take PR version)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto_merge_codex:
    if: >
      github.event.pull_request.base.ref == 'main' &&
      contains(github.event.pull_request.labels.*.name, 'codex')
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      HEAD_REF: ${{ github.event.pull_request.head.ref }}
    steps:
      - name: Configure git
        run: |
          git config --global user.name  "github-actions"
          git config --global user.email "actions@github.com"

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch PR head
        run: |
          git fetch origin +refs/heads/${HEAD_REF}:refs/remotes/origin/${HEAD_REF}

      # Always take PR versions of our controlled files.
      # If a file doesn't exist in the PR, the '|| true' prevents failure.
      - name: Overwrite deploy-controlled files from PR
        run: |
          set -e
          git checkout origin/${HEAD_REF} -- gbb/index.html || true
          git checkout origin/${HEAD_REF} -- mu-plugins/npc-gbb-bridge.php || true

          if [ -n "$(git status --porcelain)" ]; then
            git add gbb/index.html mu-plugins/npc-gbb-bridge.php 2>/dev/null || true
            git commit -m "Auto-apply PR #${PR_NUMBER}: take PR versions of deploy files"
            git push origin HEAD:main
          else
            echo "No deploy files changed; nothing to push."
          fi

      - name: Comment + close PR (GitHub API)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            // leave a note
            await github.rest.issues.createComment({
              owner, repo, issue_number: prNumber,
              body: "Auto-applied changes from this PR to `main` (took PR versions of deploy files). Closing to avoid manual conflict resolution. âœ…"
            });

            // close the PR
            await github.rest.pulls.update({
              owner, repo, pull_number: prNumber, state: 'closed'
            });
