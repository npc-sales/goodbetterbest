name: Update GBB from Issue (Manual Ready)

on:
  workflow_dispatch:
    inputs:
      base64_html:
        description: "Paste base64 HTML starting with b64: (or leave empty if using issues)"
        required: false
        type: string
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

jobs:
  deploy:
    # Only allow you to trigger via issue label, or anyone via manual button
    if: >
      (github.event_name == 'workflow_dispatch')
      || (contains(github.event.issue.labels.*.name, 'deploy') && github.actor == 'npc-sales')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine source (manual input or issue body)
        id: pick
        env:
          MANUAL: ${{ inputs.base64_html }}
          ISSUE: ${{ github.event.issue.body }}
        run: |
          set -e
          if [ -n "$MANUAL" ]; then
            echo "$MANUAL" > SOURCE.txt
            echo "mode=manual" >> $GITHUB_OUTPUT
          else
            echo "$ISSUE" > SOURCE.txt
            echo "mode=issue" >> $GITHUB_OUTPUT
          fi

      - name: Write index.html
        run: |
          python - <<'PY'
import os, base64, shutil, sys
data = open('SOURCE.txt','rb').read().decode('utf-8', 'replace').strip()
if not data:
    print("ERROR: No source provided (manual input or issue body)."); sys.exit(1)

low = data.lower().strip()
# Option 1: use: <path-in-repo>
if low.startswith('use:'):
    path = data.split(':',1)[1].strip()
    if not os.path.isfile(path):
        print("ERROR: File not found:", path); sys.exit(1)
    shutil.copy(path, 'index.html')
# Option 2: b64:<base64-of-html>
else:
    if low.startswith('b64:'):
        data = data[4:].strip()
    try:
        html = base64.b64decode(data)
    except Exception as e:
        print("ERROR: Base64 decode failed:", e); sys.exit(1)
    open('index.html','wb').write(html)
print("OK wrote index.html")
PY

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add index.html
          git commit -m "Deploy via ${GITHUB_EVENT_NAME}"
          git push

      - name: Label as deployed (issues only)
        if: github.event_name == 'issues'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: deployed

      - name: Comment + close (issues only)
        if: github.event_name == 'issues'
        uses: peter-evans/close-issue@v3
        with:
          comment: "Deployed. âœ… Visit: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
